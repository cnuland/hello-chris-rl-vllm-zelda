# Combined visualization image: WebSocket relay + PixiJS web viewer
# Serves the overworld map viewer and relays position telemetry
# from RL training pods to browser clients.
#
# Build context must be the visualization/ directory:
#   podman build -t quay.io/cnuland/zelda-map-viz:latest -f visualization/Containerfile visualization/

# ── Stage 1: Build PixiJS web frontend ──────────────────────────
FROM registry.access.redhat.com/ubi9/nodejs-20:latest AS web-builder
# UBI Node.js images use /opt/app-root/src as the writable app dir
WORKDIR /opt/app-root/src
COPY web/package.json web/package-lock.json* ./
RUN npm install
COPY web/ .
# Use the VRAM-rendered overworld map
COPY assets/overworld.png assets/overworld.png
RUN npm run build

# ── Stage 2: Production server ──────────────────────────────────
FROM registry.access.redhat.com/ubi9/nodejs-20-minimal:latest
WORKDIR /opt/app-root/src

COPY ws-server/package.json .
RUN npm install --production && npm cache clean --force

COPY ws-server/index.js .
COPY --from=web-builder /opt/app-root/src/dist ./public

EXPOSE 3344

CMD ["node", "index.js"]
