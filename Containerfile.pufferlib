FROM pytorch/pytorch:2.2.1-cuda12.1-cudnn8-runtime

USER root

# Fix expired Ubuntu GPG keys in base image, then install system deps
RUN apt-get update -o Acquire::AllowInsecureRepositories=true && \
    apt-get install -y --allow-unauthenticated ca-certificates gnupg && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 871920D1991BC93C && \
    apt-get update && apt-get install -y --no-install-recommends \
    libsdl2-dev \
    libsdl2-2.0-0 \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user with GID 0 for OpenShift compatibility
# OpenShift runs containers with a random UID but always GID 0
RUN useradd -m -s /bin/bash -g 0 trainer
WORKDIR /home/trainer

# Install Python dependencies as root (system-wide, accessible to any UID)
COPY pyproject.toml ./
RUN pip install --no-cache-dir \
    "pufferlib>=2.0" \
    "pyboy>=2.6.0" \
    "gymnasium>=0.29.0" \
    "httpx>=0.25.0" \
    "boto3>=1.28.0" \
    "Pillow>=9.0.0" \
    "PyYAML>=6.0" \
    "pydantic>=2.0.0" \
    "flask>=3.0.0"

# Copy application code (owned by root group for OpenShift random UID)
COPY agent/ ./agent/
COPY scripts/ ./scripts/
COPY data/ ./data/

# ROM files are downloaded from MinIO at startup (gitignored, not in repo)
# Make home dir and roms dir writable by GID 0
RUN mkdir -p /home/trainer/roms && \
    chgrp -R 0 /home/trainer && \
    chmod -R g=u /home/trainer

USER trainer

EXPOSE 8080

ENV ROM_PATH=/home/trainer/roms/zelda.gbc
ENV SAVE_STATE_PATH=""
ENV PYTHONPATH=/home/trainer
ENV PYTHONUNBUFFERED=1

ENTRYPOINT ["bash", "/home/trainer/scripts/entrypoint.sh"]
CMD ["python", "scripts/train_pufferlib.py"]
